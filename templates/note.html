<!-- Extend the base template which provides common HTML structure, head, and body -->
{% extends "base.html" %}

<!-- Override the page title with the current note path -->
{% block title %} {{ note_path }} - Math Notes {% endblock%}

<!-- Block for additional head content: CSS, JS libraries, and inline scripts -->
{% block extra_head %}

<!-- Load the main stylesheet for note page layout and styling -->
<link rel="stylesheet" href="/static/note_tpl_style.css">
<!-- Load additional styles for navigation buttons and search -->
<link rel="stylesheet" href="/static/style.css">

<!-- Define JavaScript constant with the list of all notes for search functionality -->
<script>
    const NOTES_META = {{ notes_meta_json|safe }};
    const NOTES_LIST = {{ notes_json|safe }};
</script>

<!-- Load Fuse.js library for fuzzy search functionality -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<!-- Load custom JavaScript for note filtering and search -->
<script src="/static/note_script.js" defer></script>
<!-- Load polyfill for ES6 features in older browsers -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<!-- Load MathJax for rendering mathematical equations -->
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

{% endblock %}

<!-- Main content block that replaces the body content in base.html -->
{% block body %}

<!-- Menu toggle button to open/close the sidebar navigation -->
<button class="menu-toggle" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar navigation containing search, filters, and note selection -->
<nav id="sidebar">
    <!-- Header section with title and home button -->
    <div class="sidebar-header">
        <h3>ðŸ“š Math Notes</h3>
        <p>Browse and search notes</p>
        <button class="home-sidebar" onclick="location.href='{{ url_for('notes.index') }}'">
            <i class="fas fa-home"></i>
        </button>
    </div>
    
    <!-- Container for upper navigation links (populated by JavaScript) -->
    <div id="up_nav">
    </div>
    
    <!-- Search section with input field and results dropdown -->
    <div class="nav-section">
        <div class="nav-section-title">Search</div>
        <div class="search-wrapper">
            <input type="text" id="search" placeholder="Search notes...">
            <div id="search-results"></div>
        </div>
    </div>
    
    <!-- Filters section for folder and subfolder selection -->
    <div class="nav-section">
        <div class="nav-section-title">Filters</div>
        <select id="folderFilter">
            {% for folder in folders %}
                <option value="{{ folder }}">{{ folder }}</option>
            {% endfor %}
        </select>
        <select id="subfolderFilter" style="margin-top: 10px;">
            <option value=""></option>
        </select>
    </div>
    
    <!-- Topics section with dropdown for note selection -->
    <div class="nav-section">
        <div class="nav-section-title">Topics</div>
        <select id="noteSelect" onchange="location = this.value;"></select>
    </div>
</nav>

<!-- JavaScript for sidebar toggle functionality -->
<script>
    // Function to toggle the sidebar open/closed state
    function toggleMenu() {
        const nav = document.getElementById('sidebar');
        const button = document.querySelector('.menu-toggle');
        nav.classList.toggle('open');
        button.classList.toggle('open');
    }
    
    // Event listener to close sidebar when clicking outside
    document.addEventListener('click', function(event) {
        const nav = document.getElementById('sidebar');
        const button = document.querySelector('.menu-toggle');
        
        if (!nav.contains(event.target) && !button.contains(event.target) && nav.classList.contains('open')) {
            toggleMenu();
        }
    });
    
    // Font size adjustment functionality
    let currentFontSize = 100;
    
    // Function to increase/decrease font size
    function adjustFontSize(change) {
        const noteContent = document.querySelector('.note-content');
        currentFontSize += change * 5;
        
        // Limit font size between 70% and 150%
        if (currentFontSize < 70) currentFontSize = 70;
        if (currentFontSize > 150) currentFontSize = 150;
        
        noteContent.style.fontSize = currentFontSize + '%';
        
        // Save to localStorage
        localStorage.setItem('noteFontSize', currentFontSize);
    }
    
    // Load saved font size on page load
    document.addEventListener('DOMContentLoaded', function() {
        const savedFontSize = localStorage.getItem('noteFontSize');
        if (savedFontSize) {
            currentFontSize = parseInt(savedFontSize);
            document.querySelector('.note-content').style.fontSize = currentFontSize + '%';
        }
    });
</script>

<!-- Navigation buttons for previous/next note -->
<div class="nav-buttons">
    {% if nav.prev %}
    <!-- Link to previous note if it exists -->
    <a id="skip_backward" href="/note/{{ nav.prev }}">
    </a>
    {% else %}
    <!-- Disabled button if no previous note -->
    <span id="skip_backward">
    </span>
    {% endif %}
    {% if nav.next %}
    <!-- Link to next note if it exists -->
    <a id="skip_forward" href="/note/{{ nav.next }}">
    </a>
    {% else %}
    <!-- Disabled button if no next note -->
    <span id="skip_forward">
    </span>
    {% endif %}
</div>
                        
<!-- Main content area displaying the note HTML -->
<div class="note-content">{{ content|safe }}</div>

<!-- Font size control buttons -->
<div class="font-size-controls">
    <button class="font-size-btn" onclick="adjustFontSize(1)" title="Increase font size">A+</button>
    <button class="font-size-btn" onclick="adjustFontSize(-1)" title="Decrease font size">Aâˆ’</button>
</div>

{% endblock %}
